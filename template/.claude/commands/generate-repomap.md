---
description: "Generate scoped repository map for external review (ChatGPT/Gemini) - auto-generates TXT and PDF"
allowed-tools: [Bash(python3 tools/generate_scoped_repomap.py:*), Bash(./tools/cleanup_repomaps.sh:*), Read(tools/repomap_scopes.json), AskUserQuestion, Bash(xclip:*), Bash(ls -lh repomaps/*:*), Bash(find repomaps -type f:*), Bash(du -sh repomaps/*:*), Bash(tree repomaps:*)]
argument-hint: "[scope-name] or leave empty for interactive selection"
---

## Instructions

Execute the scoped repomap generator with automatic TXT and PDF outputs in timestamped directories.

### Step 0: Check for Existing Repomaps (Optional Cleanup)

Before generating a new repomap, check if there are existing repomap directories:

1. Check for existing repomaps:
   ```bash
   find repomaps -type d -name "202*" 2>/dev/null | wc -l
   ```

2. If **>3 directories found**, use `AskUserQuestion` to ask:
   - **Question:** "Found multiple repomap directories. Clean up old ones before generating new one?"
   - **Header:** "Cleanup"
   - **Options:**
     - "Yes, delete old repomaps" → Run `./tools/repomap/cleanup_repomaps.sh --force`
     - "No, keep existing files" → Continue to Step 1
   - Show directory count and total size before asking

3. If **≤3 directories found**, skip directly to Step 1

### Step 1: Determine Scope

If `$ARGUMENTS` contains a scope name:
1. Use the provided scope name directly
2. Skip to Step 2

If `$ARGUMENTS` is empty:
1. Read available scopes: `cat tools/repomap_scopes.json`
2. Parse scope names and descriptions
3. Use `AskUserQuestion` to present scope options:
   - **Question:** "Which repomap scope would you like to generate?"
   - **Header:** "Scope Selection"
   - **Options:** Present all available scopes with their descriptions
   - Common scopes: review-ready, backend, frontend, workflow, specs, complete-backend
   - Add "Custom patterns" option for manual pattern specification

### Step 2: Generate Repomap (TXT + PDF)

Execute repomap generation with automatic PDF creation:

**Basic command:**
```bash
python3 tools/generate_scoped_repomap.py --scope <selected-scope> --stats
```

**The script automatically:**
- Creates timestamped directory: `repomaps/YYYYMMDD_HHMMSS/`
- Generates TXT file: `repomap-<scope>.txt`
- Converts to optimized PDF: `repomap-<scope>.pdf` (if enscript/ps2pdf available)
- Displays compression statistics

**To skip PDF generation:**
```bash
python3 tools/generate_scoped_repomap.py --scope <selected-scope> --no-pdf
```

### Step 3: Display Results

1. Show output directory structure:
   ```bash
   tree repomaps/<timestamp>/ -L 1
   ```
2. Display file statistics from script output:
   - Files included count
   - TXT file size
   - PDF file size
   - Compression ratio
3. Provide usage instructions:
   - For TXT: "Copy to clipboard (Linux): `xclip -selection clipboard < repomaps/<timestamp>/repomap-<scope>.txt`"
   - For PDF: "PDF file ready for upload to ChatGPT/Gemini at `repomaps/<timestamp>/repomap-<scope>.pdf`"
   - Suggest ChatGPT/Gemini review prompts from `tools/REPOMAP_GUIDE.md` (if exists)

### Step 4: Offer Actions

Use `AskUserQuestion` to offer:
- **Question:** "What would you like to do with the repomap?"
- **Options:**
  - "Copy TXT to clipboard" (run xclip command)
  - "Show directory location" (display path)
  - "List all repomaps" (run `tree repomaps/`)
  - "Generate another scope" (restart from Step 1)
  - "Done" (exit)

## Notes

- **New directory structure:** All repomaps organized in `repomaps/YYYYMMDD_HHMMSS/` directories
- **Automatic PDF generation:** PDF is generated by default alongside TXT file (if tools available)
- **Cleanup reminder:** Check for >3 repomap directories before generating new ones
- **Manual cleanup:** Run `./tools/cleanup_repomaps.sh` to delete all repomap files
- For custom patterns, guide user to use direct command: `python3 tools/generate_scoped_repomap.py --include "pattern"`
- For PR-specific repomaps, refer user to: `/generate-pr-repomap <PR_NUM>`
- PDF uses 4pt Courier font with word wrap and tight spacing (enscript + ps2pdf)
- PDF compression typically achieves 60-70% size reduction vs TXT
- Both TXT and PDF are in the same timestamped directory for easy organization
- Repomap files are gitignored by default (never committed to repository)
- Check `tools/REPOMAP_GUIDE.md` for detailed usage examples and ChatGPT prompts (if exists)

## Troubleshooting

**If repomap script not found:**
- Error: "tools/generate_scoped_repomap.py not found"
- Solution: Create the repomap tooling structure (see tier1 workflow documentation)

**If repomap_scopes.json not found:**
- Error: "tools/repomap_scopes.json not found"
- Solution: Create scope configuration file with project-specific scopes

**If PDF generation fails:**
- Fallback: Use `--no-pdf` flag to generate TXT only
- Check: Verify enscript and ps2pdf are installed (`which enscript ps2pdf`)
