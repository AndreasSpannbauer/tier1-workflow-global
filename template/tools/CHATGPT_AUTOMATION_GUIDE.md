# ChatGPT Repomap Automation Guide

**Fully automated ChatGPT code review with minimal manual intervention.**

## Overview

Automated workflow that:
1. ‚úÖ Authenticates to ChatGPT (gopass credentials + optional 2FA)
2. ‚úÖ Generates comprehensive repomap (Repomix 77% token reduction)
3. ‚úÖ Auto-uploads repomap + MASTER_SPEC.md (no file picker)
4. ‚úÖ Sends intelligent prompt (generated by Claude)
5. ‚úÖ Polls for response (60s intervals, 10min timeout)
6. ‚úÖ Downloads and structures response (JSON)

**Zero manual steps except 2FA authentication pause.**

## Architecture

### Script Handles (Brittle Automation)
- Browser automation via Playwright MCP
- Authentication with gopass
- File generation and upload
- Response polling and extraction

### Claude Handles (Intelligence)
- Contextual prompt generation
- Response parsing
- Patch extraction and application
- Validation

**Clean separation of concerns = robust workflow**

## Prerequisites

### Required

1. **Gopass credentials**:
   ```bash
   gopass insert chatgpt_user  # Your ChatGPT email
   gopass insert chatgpt_pw    # Your ChatGPT password
   ```

2. **Playwright MCP Extension** (installed):
   ```bash
   ~/bin/start-playwright-extension.sh
   ```

3. **Chrome with extension loaded**:
   - Extension at: `/tmp/playwright-mcp-main/extension/dist`
   - Should auto-login to ChatGPT via existing session

### Optional (for 77% token reduction)

```bash
npm install -g repomix
```

## Usage

### Full Workflow (Recommended)

```bash
# Generate comprehensive repomap + upload + send + poll + download
echo "Please review this codebase for architectural issues" | \
  python3 tools/chatgpt_repomap_automation.py --scope fullstack-review
```

**What happens:**
1. Authenticates (or resumes session)
2. Generates fullstack-review repomap (comprehensive coverage)
3. Finds and uploads `.tasks/MASTER_SPEC.md`
4. Sends prompt from stdin
5. Polls every 60s for up to 10 minutes
6. Downloads response to `chatgpt-response.json`

### Resumable Stages

**Stage 1: Authenticate**
```bash
python3 tools/chatgpt_repomap_automation.py --stage authenticate
```

**Stage 2: Upload Files**
```bash
python3 tools/chatgpt_repomap_automation.py --stage upload --scope fullstack-review
```

**Stage 3: Send Prompt**
```bash
echo "Your prompt" | python3 tools/chatgpt_repomap_automation.py --stage send-prompt
```

**Stage 4: Wait for Response**
```bash
python3 tools/chatgpt_repomap_automation.py --stage wait-response --timeout 600
```

**Stage 5: Download Response**
```bash
python3 tools/chatgpt_repomap_automation.py --stage download-response --output review.json
```

### From Slash Command (Recommended)

```bash
/chatgpt-review "Please review for security issues"
```

## Scope Selection

**Defaults to `fullstack-review` (comprehensive coverage)**

With Repomix's 77% token reduction, we can afford comprehensive scopes:

| Scope | Coverage | Token Count (approx) |
|-------|----------|----------------------|
| `fullstack-review` | backend + frontend + specs | ~500K (with Repomix) |
| `full-review` | workflow + backend + frontend | ~600K (with Repomix) |
| `complete-backend` | backend + specs + workflow | ~400K (with Repomix) |
| `review-ready` | optimized for external AI | ~300K (with Repomix) |

**Override:**
```bash
python3 tools/chatgpt_repomap_automation.py --scope review-ready
```

## State Management

### Resumable Sessions

Progress saved to `.chatgpt_session_state.json`:

```json
{
  "stage": "response_ready",
  "authenticated": true,
  "repomap_path": "/abs/path/to/repomap.txt",
  "master_spec_path": "/abs/path/to/.tasks/MASTER_SPEC.md",
  "files_uploaded": true,
  "prompt_sent": true,
  "response_ready": true,
  "started_at": "2025-11-01T12:00:00",
  "completed_at": "2025-11-01T12:08:00"
}
```

**Resume from interruption:**
```bash
# Script automatically resumes from last successful stage
python3 tools/chatgpt_repomap_automation.py --scope fullstack-review
```

**Force fresh start:**
```bash
python3 tools/chatgpt_repomap_automation.py --scope fullstack-review --no-resume
```

## Response Structure

Downloaded response saved to `chatgpt-response.json`:

```json
{
  "timestamp": "2025-11-01T12:08:00",
  "scope": "fullstack-review",
  "repomap_path": "/path/to/repomap.txt",
  "master_spec_path": "/path/to/.tasks/MASTER_SPEC.md",
  "text_blocks": [
    "Analysis text...",
    "Recommendations..."
  ],
  "code_blocks": [
    {
      "language": "python",
      "code": "def fixed_function():\n    ..."
    }
  ],
  "patches": [
    {
      "file": "src/service.py",
      "patch": "--- a/src/service.py\n+++ b/src/service.py\n..."
    }
  ],
  "raw_response": "Full response text..."
}
```

## 2FA Handling

**If 2FA is required:**

```
üîê Stage 1: Authenticating to ChatGPT...
   ‚Üí Opening ChatGPT...
   ‚Üí Checking authentication status...
   ‚Üí Not logged in, retrieving credentials...
   ‚Üí Logging in as user@example.com...
   ‚è∏Ô∏è  If 2FA is required, complete authentication now...
   Press Enter when authentication is complete...
```

**Just authenticate in the browser and press Enter - script continues automatically.**

## Error Handling

### Authentication Failed

```bash
   ‚úó Failed to retrieve credentials from gopass
   ‚Üí Ensure 'chatgpt_user' and 'chatgpt_pw' are in gopass
```

**Fix:**
```bash
gopass insert chatgpt_user
gopass insert chatgpt_pw
```

### Repomap Generation Failed

```bash
   ‚úó Failed to generate repomap
```

**Fix:**
- Check `tools/generate_scoped_repomap.py` exists
- Verify scope name: `--list-scopes`
- Check disk space

### MASTER_SPEC.md Not Found

```bash
   ‚ö†Ô∏è  MASTER_SPEC.md not found at .tasks/MASTER_SPEC.md
   ‚Üí Continuing with repomap only...
```

**Not critical** - workflow continues with repomap only.

### Response Timeout

```bash
   ‚úó Timeout after 600s
```

**Fix:**
- Increase timeout: `--timeout 900`
- Check ChatGPT isn't stuck (browser may need refresh)

## Integration with Claude

### Claude Generates Intelligent Prompts

```python
# Claude analyzes epic and generates contextual prompt
prompt = f"""
Please review this codebase for the following epic implementation:

Epic: {epic_title}
Objective: {epic_objective}

Focus areas:
1. {focus_area_1}
2. {focus_area_2}

Attached files:
- Comprehensive repomap ({scope} scope)
- Project master specification

Please provide:
1. Architectural feedback
2. Potential issues
3. Recommended improvements
4. Code examples where applicable
"""
```

### Claude Parses Response

```python
# Load structured response
with open("chatgpt-response.json") as f:
    response = json.load(f)

# Extract patches
for patch in response["patches"]:
    # Apply patch
    subprocess.run(["git", "apply"], input=patch["patch"], text=True)

# Validate
subprocess.run(["npm", "run", "validate-all"])
```

## Slash Command Integration

**Create `.claude/commands/chatgpt-review.md`:**

```markdown
---
description: "Get ChatGPT code review with automated repomap upload"
allowed-tools: [Bash]
---

# ChatGPT Code Review Automation

**Step 1: Generate prompt**

Analyze request and create contextual prompt based on:
- Epic context (if specified)
- Focus areas requested
- Review type (architecture, security, performance, etc.)

**Step 2: Run automation**

```bash
echo "$PROMPT" | python3 tools/chatgpt_repomap_automation.py \
  --scope fullstack-review \
  --timeout 600
```

**Step 3: Parse response**

Load `chatgpt-response.json` and:
1. Display text analysis
2. Extract code blocks
3. Apply patches if requested
4. Show recommendations
```

## Performance

**Typical timings:**

| Stage | Duration |
|-------|----------|
| Authentication | 5-30s (depends on 2FA) |
| Repomap generation | 10-30s (Repomix compression) |
| File upload | 5-10s |
| Prompt send | 1-2s |
| Response wait | 60-600s (depends on complexity) |
| Download | 2-5s |
| **Total** | **1.5-11 minutes** |

## Troubleshooting

### MCP Not Available

```bash
   ‚úó Playwright MCP not available
   ‚Üí Start MCP server: ~/bin/start-playwright-extension.sh
```

**Check MCP server:**
```bash
ps aux | grep playwright
curl http://localhost:8931/mcp  # Should respond
```

### Chrome Extension Not Loaded

**Reload extension:**
1. Open `chrome://extensions/`
2. Find "Playwright MCP Bridge"
3. Click reload

### Session Expired

**Clear state and reauthenticate:**
```bash
rm .chatgpt_session_state.json
python3 tools/chatgpt_repomap_automation.py --stage authenticate
```

## Future Enhancements

**Potential improvements:**

1. **Multiple AI platforms**: Gemini, Claude Pro web interface
2. **Batch processing**: Queue multiple reviews
3. **Automatic patch application**: Apply approved changes
4. **Comparison mode**: Compare responses from multiple AIs
5. **Incremental updates**: Upload only changed files

## Architecture Benefits

### Why This Design?

**Separation of Concerns:**
- ‚úÖ Script handles brittle browser automation
- ‚úÖ Claude handles intelligent prompt generation
- ‚úÖ Clear boundary = easy to debug and improve

**Resumability:**
- ‚úÖ Interruptions don't lose progress
- ‚úÖ Can retry individual stages
- ‚úÖ State persisted to JSON

**Zero Manual Steps:**
- ‚úÖ No file picker (automatic upload)
- ‚úÖ Gopass for credentials (no typing)
- ‚úÖ Only 2FA requires human input

**Comprehensive Coverage:**
- ‚úÖ Repomix 77% token reduction enables fullstack-review default
- ‚úÖ MASTER_SPEC provides project context
- ‚úÖ More context = better feedback

## Examples

### Architecture Review

```bash
echo "Review the overall architecture for scalability and maintainability" | \
  python3 tools/chatgpt_repomap_automation.py --scope fullstack-review
```

### Security Audit

```bash
echo "Perform security audit focusing on authentication and data handling" | \
  python3 tools/chatgpt_repomap_automation.py --scope complete-backend
```

### Performance Analysis

```bash
echo "Analyze for performance bottlenecks and optimization opportunities" | \
  python3 tools/chatgpt_repomap_automation.py --scope fullstack-review --timeout 900
```

### Epic-Specific Review

```bash
# Claude generates contextual prompt
PROMPT="Review EPIC-025 implementation (async email processing).
Focus on:
1. Proper async/await usage
2. Error handling in pipeline
3. Database transaction boundaries
Attached: fullstack-review repomap + MASTER_SPEC.md"

echo "$PROMPT" | python3 tools/chatgpt_repomap_automation.py
```

---

**Last Updated**: 2025-11-01
**Status**: Production Ready (MCP integration pending)
