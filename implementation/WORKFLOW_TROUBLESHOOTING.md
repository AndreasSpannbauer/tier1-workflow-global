# Workflow Troubleshooting Guide

**Last Updated:** 2025-10-19
**Status:** Production Ready
**Location:** `~/tier1_workflow_global/implementation/`

---

## Table of Contents

1. [Epic Not Ready for Execution](#epic-not-ready-for-execution)
2. [Git Working Directory Not Clean](#git-working-directory-not-clean)
3. [Validation Failures](#validation-failures)
4. [Implementation Agent Errors](#implementation-agent-errors)
5. [Package.json Scripts Missing](#packagejson-scripts-missing)
6. [Agent Briefings Not Found](#agent-briefings-not-found)
7. [Parallel Execution Issues](#parallel-execution-issues)
8. [Permission Errors](#permission-errors)
9. [Worktree Issues](#worktree-issues)
10. [Result JSON Not Created](#result-json-not-created)

---

## Epic Not Ready for Execution

### Symptom

```
❌ Phase 0: Preflight FAILED

Epic EPIC-042 is not ready for execution.

Missing files:
  - spec.md ❌
  - architecture.md ❌
  - file-tasks.md ❌
```

### Root Cause

The epic directory is missing required files:
- `spec.md` - Epic specification
- `architecture.md` - Architecture design
- `implementation-details/file-tasks.md` - Prescriptive plan

### Solution

**Step 1: Verify epic exists**
```bash
ls .tasks/backlog/ | grep EPIC-042
# Should show directory like: EPIC-042-add-email-validation
```

**Step 2: Check existing files**
```bash
ls -la .tasks/backlog/EPIC-042-*/
# Shows what files are present
```

**Step 3: Run refinement**
```bash
# Generate missing files
/refine-epic EPIC-042
```

This will:
1. Read spec.md (or create if missing)
2. Generate architecture.md
3. Generate implementation-details/file-tasks.md

**Step 4: Verify files created**
```bash
ls .tasks/backlog/EPIC-042-*/
# Should show:
# - spec.md
# - architecture.md
# - implementation-details/

ls .tasks/backlog/EPIC-042-*/implementation-details/
# Should show:
# - file-tasks.md
```

**Step 5: Re-run workflow**
```bash
/execute-workflow EPIC-042
```

### Prevention

Always run `/refine-epic` before `/execute-workflow`:

```bash
# 1. Create epic
/spec-epic

# 2. Refine (generate architecture + file-tasks)
/refine-epic EPIC-042

# 3. Execute workflow
/execute-workflow EPIC-042
```

---

## Git Working Directory Not Clean

### Symptom

```
❌ Phase 0: Preflight FAILED

Git working directory is not clean.

Uncommitted changes:
  - src/backend/service.py (modified)
  - src/frontend/component.tsx (modified)
  - new_file.py (untracked)

Please commit or stash changes before running workflow.
```

### Root Cause

The workflow requires a clean git state to:
- Ensure all changes come from the workflow execution
- Enable clean rollback if workflow fails
- Create atomic commits for each epic

### Solution

**Option 1: Commit existing changes**
```bash
# Review changes
git status
git diff

# Commit changes
git add .
git commit -m "WIP: Prepare for workflow"

# Verify clean state
git status
# Should show: "nothing to commit, working tree clean"

# Re-run workflow
/execute-workflow EPIC-042
```

**Option 2: Stash changes temporarily**
```bash
# Stash uncommitted changes
git stash push -m "Before EPIC-042 workflow"

# Verify clean state
git status
# Should show: "nothing to commit, working tree clean"

# Run workflow
/execute-workflow EPIC-042

# After workflow completes, restore stashed changes
git stash pop
```

**Option 3: Create temporary branch**
```bash
# Create branch with current changes
git checkout -b temp-work

# Commit changes
git add .
git commit -m "Temporary work"

# Switch back to main
git checkout main

# Verify clean state
git status

# Run workflow
/execute-workflow EPIC-042

# After workflow, merge or cherry-pick if needed
git merge temp-work
```

### Prevention

- Commit frequently during manual work
- Use separate branches for manual experiments
- Run workflow on clean main/develop branch

---

## Validation Failures

### Symptom

```
❌ Phase 2: Validation FAILED (attempt 3/3)

Validation errors persist after 3 fix attempts.

Errors:
  - src/backend/service.py:42: Missing type hint for 'db' parameter
  - src/backend/api/routes.py:18: Unused import 'HTTPException'
  - src/backend/models/email.py:25: Incompatible return type

Manual intervention required.
```

### Root Cause

Code generated by implementation agent has errors that the build_fixer_agent_v1 cannot automatically fix:
- Complex type hint issues
- Architectural mismatches
- Missing dependencies
- Logic errors

### Solution

**Step 1: Review validation errors**
```bash
# Check detailed error log
cat .workflow/outputs/EPIC-042/validation_errors.log

# Or run validation manually
npm run validate
```

**Step 2: Identify error categories**

**Type hint errors:**
```
src/backend/service.py:42: Missing type hint for 'db' parameter
```

**Fix:**
```python
# Before (missing type hint)
async def get_email(email_id: int, db):
    ...

# After (type hint added)
async def get_email(email_id: int, db: AsyncSession) -> Email:
    ...
```

**Unused import errors:**
```
src/backend/api/routes.py:18: Unused import 'HTTPException'
```

**Fix:**
```python
# Remove unused import
# from fastapi import HTTPException  ❌
from fastapi import APIRouter, Depends  # ✅
```

**Type compatibility errors:**
```
src/backend/models/email.py:25: Incompatible return type
```

**Fix:**
```python
# Before (incompatible)
async def get_email(email_id: int) -> Email:
    return await self.db.get(Email, email_id)  # Returns Email | None

# After (handle None)
async def get_email(email_id: int) -> Email:
    email = await self.db.get(Email, email_id)
    if not email:
        raise EmailNotFoundError(f"Email {email_id} not found")
    return email
```

**Step 3: Fix errors manually**
```bash
# Edit files to fix errors
nano src/backend/service.py

# Re-run validation
npm run validate
```

**Step 4: Commit fixes**
```bash
git add .
git commit -m "fix(EPIC-042): Fix validation errors"
```

**Step 5: Update briefings (prevent future issues)**
```bash
# Edit backend briefing to clarify patterns
nano .claude/agent_briefings/backend_implementation.md

# Add examples for common error patterns
```

### Common Validation Issues

**Python:**
- Missing type hints (add `: Type` and `-> ReturnType`)
- Unused imports (remove or use)
- Line length violations (break long lines)
- Missing error handling (add try/except)

**TypeScript:**
- Type errors (add proper interfaces)
- Lint violations (fix formatting)
- Unused variables (remove or prefix with `_`)
- Missing return types (add explicit return type)

### Prevention

**Improve agent briefings:**
```markdown
# .claude/agent_briefings/backend_implementation.md

## Type Hints (MANDATORY)

ALL functions must have complete type hints:

```python
# ✅ CORRECT
async def get_email(self, email_id: int) -> Email:
    ...

# ❌ WRONG
async def get_email(email_id):
    ...
```
```

**Add validation to implementation phase:**

Update agent definition to run validation before completing:

```markdown
## Validation Before Completing

Before writing results JSON, verify:

1. All files in file-tasks.md created/modified
2. No syntax errors: `python -m py_compile <file>`
3. No linting errors: `ruff check <file>`
4. All functions have type hints
```

---

## Implementation Agent Errors

### Symptom

```
❌ Phase 1: Implementation FAILED

Implementation agent encountered errors:

Error: Cannot parse file-tasks.md
Line 42: File path unclear: "src/backend/service.py (update EmailService class)"

Implementation aborted.
```

### Root Cause

The prescriptive plan (file-tasks.md) is unclear or incorrectly formatted:
- Ambiguous file paths
- Unclear instructions
- Missing context
- File paths don't match project structure

### Solution

**Step 1: Review file-tasks.md**
```bash
cat .tasks/backlog/EPIC-042-*/implementation-details/file-tasks.md
```

**Step 2: Identify issues**

**Issue 1: Ambiguous file paths**
```markdown
❌ WRONG:
- Update service.py (add email validation)

✅ CORRECT:
- `src/backend/services/email_service.py` (create new)
  - Add EmailService class
  - Implement create_email() method
  - Add error handling
```

**Issue 2: Unclear instructions**
```markdown
❌ WRONG:
- Modify routes.py (add stuff)

✅ CORRECT:
- `src/backend/api/email_routes.py` (modify)
  - Add POST /emails endpoint
  - Integrate with EmailService
  - Add error handling for 404 and 500 errors
```

**Issue 3: Missing file paths**
```markdown
❌ WRONG:
- Create email validation

✅ CORRECT:
- `src/backend/validators/email_validator.py` (create new)
  - Implement validate_email() function
  - Check format using regex
  - Raise ValidationError for invalid emails
```

**Step 3: Regenerate file-tasks.md**
```bash
# Re-run refinement with better context
/refine-epic EPIC-042

# Or manually edit file-tasks.md
nano .tasks/backlog/EPIC-042-*/implementation-details/file-tasks.md
```

**Step 4: Verify format**

Ensure file-tasks.md follows this format:

```markdown
# Implementation Plan: EPIC-042

## Files to Create

### `src/backend/services/email_service.py`

**Purpose:** Email business logic service

**Requirements:**
- Create EmailService class
- Implement create_email(email_data: EmailCreate) -> Email
- Add error handling (EmailNotFoundError, DatabaseError)
- Use dependency injection for database session

**Dependencies:**
- SQLAlchemy AsyncSession
- Email model from models/email.py
- EmailCreate schema from schemas/email.py

## Files to Modify

### `src/backend/api/__init__.py`

**Changes:**
- Import email_routes router
- Add router to main app: `app.include_router(email_routes.router)`

**Location:** Line 10 (after existing router imports)
```

**Step 5: Re-run workflow**
```bash
/execute-workflow EPIC-042
```

### Prevention

**Improve epic refinement:**

When running `/refine-epic`, ensure:
1. Spec.md has clear requirements
2. Architecture.md specifies file structure
3. File-tasks.md uses absolute paths
4. Instructions are specific and actionable

**Template for file-tasks.md:**
```markdown
## Files to Create

### `absolute/path/to/file.py`
- Purpose: [What this file does]
- Requirements: [Specific functionality to implement]
- Dependencies: [What it imports/uses]

## Files to Modify

### `absolute/path/to/existing_file.py`
- Changes: [Specific modifications]
- Location: [Where to make changes]
- Preserve: [What NOT to change]
```

---

## Package.json Scripts Missing

### Symptom

```
❌ Phase 2: Validation FAILED

Validation command not found: npm run validate

Error: Missing script: "validate"
```

### Root Cause

Your `package.json` doesn't have the required validation scripts.

### Solution

**Step 1: Check existing scripts**
```bash
cat package.json | grep -A 10 '"scripts"'
```

**Step 2: Add validation scripts**

**For Python projects:**
```json
{
  "name": "your-project",
  "scripts": {
    "validate": "ruff check src/ && mypy src/"
  }
}
```

**For TypeScript projects:**
```json
{
  "name": "your-project",
  "scripts": {
    "lint": "eslint src/ --ext .ts,.tsx",
    "type-check": "tsc --noEmit",
    "validate": "npm run lint && npm run type-check"
  }
}
```

**For Python + TypeScript projects:**
```json
{
  "name": "your-project",
  "scripts": {
    "validate:python": "ruff check src/backend/ && mypy src/backend/",
    "validate:typescript": "npm run lint && npm run type-check",
    "validate": "npm run validate:python && npm run validate:typescript"
  }
}
```

**Step 3: Install dependencies**

**Python:**
```bash
pip install ruff mypy
```

**TypeScript:**
```bash
npm install --save-dev eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin typescript
```

**Step 4: Test validation**
```bash
npm run validate
```

**Step 5: Re-run workflow**
```bash
/execute-workflow EPIC-042
```

### Prevention

Add validation scripts to project template:

```bash
# Create template package.json
cat > package.json.template << 'EOF'
{
  "name": "project-template",
  "scripts": {
    "validate:python": "ruff check src/ && mypy src/",
    "validate:typescript": "eslint src/ && tsc --noEmit",
    "validate": "npm run validate:python && npm run validate:typescript"
  },
  "devDependencies": {
    "eslint": "^8.0.0",
    "typescript": "^5.0.0"
  }
}
EOF
```

---

## Agent Briefings Not Found

### Symptom

```
❌ Phase 1: Implementation FAILED

Agent briefing not found: .claude/agent_briefings/backend_implementation.md

Cannot deploy implementation agent without domain briefing.
```

### Root Cause

Agent briefings are missing from your project's `.claude/agent_briefings/` directory.

### Solution

**Step 1: Check if briefings exist**
```bash
ls .claude/agent_briefings/
```

**Step 2: Copy briefing templates**
```bash
# Create directory if missing
mkdir -p .claude/agent_briefings

# Copy templates from tier1_workflow_global
cp ~/tier1_workflow_global/implementation/agent_briefings/*.md \
   .claude/agent_briefings/

# Verify
ls .claude/agent_briefings/
# Should show:
# - backend_implementation.md
# - project_architecture.md
```

**Step 3: Customize briefings for your project**
```bash
# Edit backend briefing
nano .claude/agent_briefings/backend_implementation.md

# Update:
# - Technology stack
# - File structure
# - Naming conventions
# - Coding patterns
```

**Step 4: Re-run workflow**
```bash
/execute-workflow EPIC-042
```

### Prevention

**Add briefings to project setup checklist:**

When starting a new project:
1. Copy workflow command to `~/.claude/commands/`
2. Copy agent definitions to `~/.claude/agent_definitions/`
3. Copy agent briefings to `.claude/agent_briefings/`
4. Customize briefings for project
5. Test workflow with small epic

---

## Parallel Execution Issues

### Symptom

```
❌ Phase 1B: Parallel Implementation FAILED

Worktree creation failed for domain: backend

Error: fatal: cannot create directory '.workflow/worktrees/backend': Permission denied
```

### Root Cause

Parallel execution requires creating temporary git worktrees, which may fail due to:
- Permission issues
- Disk space
- Existing worktrees
- Git configuration

### Solution

**Step 1: Check permissions**
```bash
# Verify write access to .workflow directory
ls -la .workflow/
mkdir -p .workflow/worktrees/
```

**Step 2: Clean up existing worktrees**
```bash
# List existing worktrees
git worktree list

# Remove stale worktrees
git worktree prune

# Force remove if needed
rm -rf .workflow/worktrees/*
```

**Step 3: Check disk space**
```bash
df -h .
# Ensure sufficient space for temporary worktrees
```

**Step 4: Force sequential execution**

If parallel execution continues to fail, force sequential:

```bash
# Manually override parallel detection
# Edit file-tasks.md to reduce file count below threshold
nano .tasks/backlog/EPIC-042-*/implementation-details/file-tasks.md

# Or disable parallel execution in workflow command
# (temporary workaround)
```

**Step 5: Re-run workflow**
```bash
/execute-workflow EPIC-042
```

### Prevention

**Configure parallel detection thresholds:**

```bash
# Adjust thresholds in workflow command
# More conservative settings:
MIN_FILES=10           # Higher minimum (default: 5)
MIN_DOMAINS=3          # Higher minimum (default: 2)
MAX_OVERLAP=20         # Lower overlap (default: 30)
```

---

## Permission Errors

### Symptom

```
❌ Phase 1: Implementation FAILED

Error: Permission denied when writing file:
  src/backend/service.py

Please check file permissions.
```

### Root Cause

Implementation agent cannot write to project directories due to:
- File ownership issues
- Read-only filesystem
- Protected directories

### Solution

**Step 1: Check file ownership**
```bash
ls -la src/backend/
```

**Step 2: Fix ownership**
```bash
# Fix ownership for project directory
sudo chown -R $USER:$USER .

# Or specific directory
sudo chown -R $USER:$USER src/
```

**Step 3: Check permissions**
```bash
# Ensure directories are writable
chmod -R u+w src/
```

**Step 4: Check filesystem**
```bash
# Verify filesystem is not read-only
mount | grep "$(df . | tail -1 | awk '{print $1}')"
```

**Step 5: Re-run workflow**
```bash
/execute-workflow EPIC-042
```

---

## Worktree Issues

### Symptom

```
❌ Phase 1B: Parallel Implementation FAILED

Cannot merge worktree changes back to main.

Error: Merge conflict in src/backend/api/__init__.py
```

### Root Cause

When using parallel execution, multiple agents may modify overlapping files, causing merge conflicts when merging worktree changes back to main.

### Solution

**Step 1: Check worktree status**
```bash
# List all worktrees
git worktree list

# Navigate to problematic worktree
cd .workflow/worktrees/backend

# Check status
git status
```

**Step 2: Resolve conflicts manually**
```bash
# View conflict
cat src/backend/api/__init__.py

# Edit to resolve conflict
nano src/backend/api/__init__.py

# Stage resolved file
git add src/backend/api/__init__.py
git commit
```

**Step 3: Clean up worktrees**
```bash
# Return to main directory
cd ../../..

# Remove worktrees
git worktree remove .workflow/worktrees/backend
git worktree prune
```

**Step 4: Re-run workflow (sequential)**
```bash
# Force sequential execution to avoid conflicts
/execute-workflow EPIC-042
```

### Prevention

**Improve parallel detection:**

Parallel detection should prevent file overlap, but if conflicts persist:

1. Adjust overlap threshold (lower = stricter):
   ```bash
   MAX_OVERLAP=10  # Default: 30
   ```

2. Review file-tasks.md for implicit dependencies:
   ```bash
   # Ensure backend and frontend don't modify same files
   cat .tasks/backlog/EPIC-042-*/implementation-details/file-tasks.md
   ```

---

## Result JSON Not Created

### Symptom

```
❌ Phase 1: Implementation FAILED

Implementation results not found:
  .workflow/outputs/EPIC-042/phase1_results.json

Agent may have crashed or failed to complete.
```

### Root Cause

Implementation agent didn't write results JSON due to:
- Agent crash or timeout
- File write permission error
- Logic error in agent

### Solution

**Step 1: Check if agent started**
```bash
# Check if output directory was created
ls .workflow/outputs/EPIC-042/

# Check for any partial results
ls -la .workflow/outputs/EPIC-042/
```

**Step 2: Review agent logs**
```bash
# Check Claude Code session logs
# Look for implementation agent output

# Check for errors in terminal
```

**Step 3: Verify output directory permissions**
```bash
# Ensure directory is writable
ls -la .workflow/outputs/

# Fix if needed
chmod -R u+w .workflow/outputs/
```

**Step 4: Re-run workflow**
```bash
/execute-workflow EPIC-042
```

### Prevention

**Update agent definition to ensure results are always written:**

```markdown
## Final Checklist

Before completing:

- [ ] All specified files created/modified
- [ ] No syntax errors
- [ ] Error handling added
- [ ] Type hints present (Python)
- [ ] Existing tests pass (if applicable)
- [ ] **Results JSON written to .workflow/outputs/{EPIC_ID}/implementation_results.json**
- [ ] Status accurately reflects completion state
```

---

## Getting Help

If you encounter issues not covered here:

1. **Check documentation:**
   - [WORKFLOW_INTEGRATION_GUIDE.md](./WORKFLOW_INTEGRATION_GUIDE.md)
   - [WORKFLOW_EXAMPLE.md](./WORKFLOW_EXAMPLE.md)
   - [WORKFLOW_CUSTOMIZATION.md](./WORKFLOW_CUSTOMIZATION.md)

2. **Review result artifacts:**
   ```bash
   cat .workflow/outputs/EPIC-042/phase1_results.json
   cat .workflow/outputs/EPIC-042/validation_results.json
   cat .workflow/outputs/EPIC-042/validation_errors.log
   ```

3. **Check git state:**
   ```bash
   git status
   git log -1 -p
   ```

4. **Validate manually:**
   ```bash
   npm run validate
   ```

5. **Review agent briefings:**
   ```bash
   cat .claude/agent_briefings/backend_implementation.md
   ```

---

## Quick Reference

**Epic not ready:**
```bash
/refine-epic EPIC-042
```

**Git not clean:**
```bash
git add . && git commit -m "WIP"
```

**Validation errors:**
```bash
cat .workflow/outputs/EPIC-042/validation_errors.log
npm run validate
```

**Package.json scripts missing:**
```json
{
  "scripts": {
    "validate": "ruff check src/ && mypy src/"
  }
}
```

**Agent briefings missing:**
```bash
cp ~/tier1_workflow_global/implementation/agent_briefings/*.md .claude/agent_briefings/
```

**Parallel execution issues:**
```bash
git worktree prune
rm -rf .workflow/worktrees/*
```
