version: '3.8'

# SCALAR Database Stack
# Updated for ~/SCALAR deployment
# Use: docker-compose up -d

services:
  # PostgreSQL - Primary data store
  postgres:
    image: postgres:15-alpine
    container_name: scalar-postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-scalar_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      POSTGRES_DB: ${POSTGRES_DB:-scalar_db}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ${SCALAR_ROOT:-~/SCALAR}/data/postgres:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-scalar_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - scalar-network

  # Redis - Cache and task queue
  redis:
    image: redis:7-alpine
    container_name: scalar-redis
    restart: always
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD must be set}
      --appendonly yes
      --appendfsync everysec
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
    volumes:
      - ${SCALAR_ROOT:-~/SCALAR}/data/redis:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - scalar-network

  # Elasticsearch - Full-text search
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: scalar-elasticsearch
    restart: always
    environment:
      - node.name=scalar-es01
      - cluster.name=scalar-cluster
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD:?ELASTICSEARCH_PASSWORD must be set}
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - ${SCALAR_ROOT:-~/SCALAR}/data/elasticsearch:/usr/share/elasticsearch/data
    ports:
      - "${ELASTICSEARCH_PORT:-9200}:9200"
    healthcheck:
      test: ["CMD-SHELL", "curl -s -u elastic:${ELASTICSEARCH_PASSWORD} http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\\|yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - scalar-network

  # Qdrant - Vector database (SCALAR instance)
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: scalar-qdrant
    restart: always
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO
    volumes:
      - ${SCALAR_ROOT:-~/SCALAR}/data/qdrant:/qdrant/storage
    ports:
      - "${QDRANT_PORT:-6333}:6333"
      - "6334:6334"  # gRPC
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - scalar-network

  # Qdrant - Vector database (Obsidian instance)
  qdrant-obsidian:
    image: qdrant/qdrant:v1.7.4
    container_name: scalar-qdrant-obsidian
    restart: always
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6336
      - QDRANT__LOG_LEVEL=INFO
    volumes:
      - ${SCALAR_ROOT:-~/SCALAR}/data/qdrant-obsidian:/qdrant/storage
    ports:
      - "${QDRANT_OBSIDIAN_PORT:-6334}:6333"
      - "6336:6336"  # gRPC
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - scalar-network

networks:
  scalar-network:
    driver: bridge

volumes:
  # Named volumes for easier backup
  postgres-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${SCALAR_ROOT:-~/SCALAR}/data/postgres

  redis-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${SCALAR_ROOT:-~/SCALAR}/data/redis

  elasticsearch-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${SCALAR_ROOT:-~/SCALAR}/data/elasticsearch

  qdrant-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${SCALAR_ROOT:-~/SCALAR}/data/qdrant

  qdrant-obsidian-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${SCALAR_ROOT:-~/SCALAR}/data/qdrant-obsidian

# Usage:
#
# Start all services:
#   docker-compose up -d
#
# Stop all services:
#   docker-compose down
#
# View logs:
#   docker-compose logs -f
#
# View logs for specific service:
#   docker-compose logs -f postgres
#
# Restart specific service:
#   docker-compose restart postgres
#
# Check service health:
#   docker-compose ps
#
# Remove all data (DANGEROUS):
#   docker-compose down -v
#   rm -rf ${SCALAR_ROOT}/data/*
